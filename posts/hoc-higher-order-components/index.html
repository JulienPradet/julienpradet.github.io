<!doctype html><html lang="fr" data-reactroot="" data-reactid="1" data-react-checksum="697850603"><head data-reactid="2"><title data-react-helmet="true">HOC pour Higher Order Component | Julien Pradet</title><meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="X-UA-Compatible" content="IE=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" name="description" content="Plutôt que de vous parler pûrement de React, dans cet article, je vais plutôt essayer de présenter l&#x27;essence d&#x27;un HOC parce que ça peut aussi vous être utile dans d&#x27;autres domaines."/><meta data-react-helmet="true" name="theme-color" content="#00C9C9"/><meta data-react-helmet="true" property="twitter:site" content="@JulienPradet"/><meta data-react-helmet="true" property="twitter:card" content="summary"/><meta data-react-helmet="true" property="twitter:creator" content="@JulienPradet"/><meta data-react-helmet="true" property="twitter:title" content="HOC pour Higher Order Component"/><meta data-react-helmet="true" property="twitter:description" content="Plutôt que de vous parler pûrement de React, dans cet article, je vais plutôt essayer de présenter l&#x27;essence d&#x27;un HOC parce que ça peut aussi vous être utile dans d&#x27;autres domaines."/><meta data-react-helmet="true" property="twitter:image" content="https://pbs.twimg.com/profile_images/424964348461600768/aygHDGpF.png"/><meta data-react-helmet="true" property="og:site_name" content="Enchanté, Julien Pradet"/><meta data-react-helmet="true" property="og:type" content="page"/><meta data-react-helmet="true" property="og:title" content="HOC pour Higher Order Component"/><meta data-react-helmet="true" property="og:url" content="https://www.julienpradet.fr/posts/hoc-higher-order-components/"/><meta data-react-helmet="true" property="og:image" content="https://pbs.twimg.com/profile_images/424964348461600768/aygHDGpF.png"/><meta data-react-helmet="true" property="og:description" content="Plutôt que de vous parler pûrement de React, dans cet article, je vais plutôt essayer de présenter l&#x27;essence d&#x27;un HOC parce que ça peut aussi vous être utile dans d&#x27;autres domaines."/><link data-react-helmet="true" rel="canonical" href="https://www.julienpradet.fr/posts/hoc-higher-order-components/"/><link data-react-helmet="true" rel="preload" href="/css/main.css" as="style"/><link data-react-helmet="true" rel="stylesheet" href="/css/main.css"/><link data-react-helmet="true" rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><link data-react-helmet="true" rel="icon" href="/favicon.ico" type="image/x-icon"/><link data-react-helmet="true" rel="manifest" href="/manifest.json"/></head><body data-reactid="3"><div id="root" data-reactid="4"><div data-reactroot="" data-reactid="1" data-react-checksum="1843278784"><!-- react-empty: 2 --><!-- react-empty: 3 --><!-- react-empty: 4 --><!-- react-empty: 5 --><!-- react-empty: 6 --><div class="page" data-reactid="7"><script data-reactid="8">window.location.href = "https://www.julienpradet.fr/posts/hoc-higher-order-components/"</script><!-- react-empty: 9 --><div data-reactid="10"><div class="page-header" data-reactid="11"><h1 data-reactid="12"><a href="/" data-reactid="13">HOC pour Higher Order Component</a></h1><header data-reactid="14"><time data-reactid="15">Friday, January 27, 2017</time></header></div><div class="info" data-reactid="16"><!-- react-text: 17 -->Attention, j&#x27;ai changé d&#x27;hébergement. Ca se passe maintenant sur <!-- /react-text --><a href="https://www.julienpradet.fr" data-reactid="18">https://www.julienpradet.fr</a><!-- react-text: 19 -->. :)<!-- /react-text --><div style="margin-top:0.5em;" data-reactid="20"><a href="https://www.julienpradet.fr/posts/hoc-higher-order-components/" data-reactid="21">Accéder à l&#x27;article sur le nouvel hébergement.</a></div></div><div class="page-content" data-reactid="22"><div data-reactid="23"><div data-reactid="24"><p>Cet article fait suite à la conf' que j'ai donné au ToulouseJS de Janvier 2017. <a href="https://julienpradet.github.io/slides/hoc/#/0?_k=cs90gj">Les slides sont disponibles.</a> Le format article est un petit peu long. Mais vous pouvez essayer de suivre les slides et raccrocher ici quand vous êtes perdu.</p>
<p>Le principe des HOC (a.k.a. Higher Order Component) est un pattern qui a été popularisé par <a href="https://twitter.com/dan_abramov">Dan Abramov</a> dans <a href="https://medium.com/@dan_abramov/mixins-are-dead-long-live-higher-order-components-94a0d2f9e750#.alh0a0zad">son article qui propose une alternative aux Mixins en React</a>.</p>
<p>Si vous n'avez pas vraiment fait de programmation fonctionnelle jusque là, vous pensez certainement que c'est un gros mot fait pour des hurluberlus passionnés par les maths. Après tout, le nom est inspiré des <a href="https://en.wikipedia.org/wiki/Higher-order_function">Higher Order Functions</a> (a.k.a. <a href="https://fr.wikipedia.org/wiki/Fonction_d%27ordre_sup%C3%A9rieur">Fonction d'Ordre Supérieur</a>), qui sont des fonctions qui ont pour paramètre des fonctions (<small><code>(f, data) =&gt; result</code></small>) et/ou qui renvoient des fonctions (<small><code>(param) =&gt; g</code></small>).</p>
<p>Mais le pattern HOC est une version simplifiée des HOF. Après avoir lu cet article, vous devriez avoir suffisamment de billes pour savoir comment et pourquoi utiliser ce pattern.</p>
<h2 id="kesako"><a class="header-anchor" href="#kesako" aria-hidden="true">#</a> Késako ?</h2>
<p>Tout d'abord ce qu'il est important de comprendre, c'est que derrière ce pattern se retrouve une seule formule : <code>(Base) =&gt; Enhanced</code>. Le HOC sera une fonction qui, à partir d'un truc de base, renvoie un truc amélioré. Le but derrière tout ça est de <em>rendre votre code plus</em> <strong><em>lisible</em></strong> en cachant la logique derrière une fonction.</p>
<blockquote>
<p><em>– Ouais, bah c'est le principe d'une fonction hein !</em> – Tout à fait. :)</p>
</blockquote>
<h3 id="avec-des-tableaux-quest-ce-que-ca-donne"><a class="header-anchor" href="#avec-des-tableaux-quest-ce-que-ca-donne" aria-hidden="true">#</a> Avec des tableaux, qu'est ce que ça donne ?</h3>
<p>Prenons l'exemple d'une fonction qui prend en entrée une liste de questions et renvoie une liste de réponses.</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> answerQuestions <span class="token punctuation">(</span>questions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> questions
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">isNotTroll</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">canIAnswer</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">rephraseIfNeeded</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">computeAnswer</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Le type de départ est un tableau. Le type d'arrivée est un tableau. Vous pouvez donc considérer que c'est un HOA : Higher Order Array. <em>Ce concept, dans la vraie vie, n'existe pas.</em> D'ailleurs, si vous êtes un pro du fonctionnel, vous avez peut-être envie de me sauter à la gorge en ce moment même, étant donné qu'un tableau n'est, ni de près, ni de loin, une fonction. Mais je trouve qu'il représente assez bien le concept.</p>
<p>Si ça peut vous aider, vous pouvez même appeler ça une <em>Factory</em>. Je ne vous en voudrais pas parce que ça m'a aidé aussi. Ou <em>Enhancer</em>.</p>
<p>Maintenant, considérons que la personne qui va lire votre code ne connait ni <code>filter</code>, ni <code>map</code> mais qu'elle a envie de comprendre ce que fait la fonction <code>answerQuestions</code>. Vous allez donc devoir améliorer un petit peu plus la lisiblité de votre code :</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> filterQuestions <span class="token punctuation">(</span>questions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> questions
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">isNotTroll</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">canIAnswer</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> getAnswers <span class="token punctuation">(</span>questions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> questions
   <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">rephraseIfNeeded</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">computeAnswer</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> answerQuestions <span class="token punctuation">(</span>questions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> valuableQuestions <span class="token operator">=</span> <span class="token function">filterQuestions</span><span class="token punctuation">(</span>questions<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">getAnswers</span><span class="token punctuation">(</span>valuableQuestions<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>En soit, vous avez juste découpé votre fonction en deux et nommé les convenablement vos fonctions et variables. Mais, la personne qui lira ce bout de code comprendra les étapes pour construire les réponses plus facilement que si elle a besoin d'aller chercher sur MDN la définition du <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Array/map"><code>map</code></a> et du <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Array/filter"><code>filter</code></a>.</p>
<p>Et maintenant, on en vient à l'avantage majeur des HOC : la composition. Puisque <code>filterQuestions</code> et <code>getAnswers</code> sont eux aussi des HOC, vous allez pouvoir les mettre bout à bout pour construire le HOC plus global <code>answerQuestions</code>.</p>
<pre class="language-jsx"><code><span class="token keyword">var</span> answerQuestions <span class="token operator">=</span> <span class="token function">pipe</span><span class="token punctuation">(</span>
  filterQuestions<span class="token punctuation">,</span>
  getAnswers
<span class="token punctuation">)</span>
</code></pre>
<p>Ce qui se lit : <em><code>answerQuestions</code> est la succession des étapes <code>filterQuestions</code> et <code>getAnswers</code></em>.<br>
<small><a href="http://ramdajs.com/0.21.0/docs/#pipe"><code>pipe</code> est tiré de ramda.</a> <a href="https://lodash.com/docs#flow">L'équivalent serait <code>flow</code> en lodash.</a></small></p>
<p>Si cette étape de composition vous paraît trop complexe, ce n'est pas grave. Vous pourrez toujours y revenir plus tard quand vous serez plus à l'aise avec les fonctions de fonctions.</p>
<h3 id="et-en-react"><a class="header-anchor" href="#et-en-react" aria-hidden="true">#</a> Et en React ?</h3>
<p>C'est la même chose ! A partir d'un <code>Composant</code>, on va retourner un <code>Composant</code> amélioré : <code>(BaseComponent) =&gt; EnhancedComponent</code>.</p>
<h4 id="loader"><a class="header-anchor" href="#loader" aria-hidden="true">#</a> Loader</h4>
<p>Prenons l'exemple d'un composant qui affiche un spinner tant qu'il est entrain de charger et le nom de l'utilisateur quand il a fini. Plutôt que de vous montrer un HOC tout fait, je vais montrer comment on en vient à en extraire un.</p>
<p>Voici notre composant initial :</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> <span class="token function">User</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> props<span class="token punctuation">.</span>loading
    <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StylishSpinner</span> <span class="token punctuation">/></span></span>
    <span class="token punctuation">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
        <span class="token punctuation">{</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>
</code></pre>
<p>Ce qui est gênant ici, c'est que la partie qui apporte réellement de la valeur (<em>comment est-ce que j'affiche un user</em>) et noyée avec la partie qui s'occupe de l'affichage du chargement. On va donc l'extraire :</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> DumbUser <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
      <span class="token punctuation">{</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> User <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> props<span class="token punctuation">.</span>loading
    <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StylishSpinner</span> <span class="token punctuation">/></span></span>
    <span class="token punctuation">:</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DumbUser</span> <span class="token punctuation">/></span></span>
<span class="token punctuation">}</span>
</code></pre>
<p>Maintenant, imaginez que ce <code>StylishSpinner</code> vous l'utilisiez pour représenter le chargement partout dans votre application. Cela veut dire que vous allez devoir réécrire cette même logique à chaque fois. Pire encore, cela veut dire que vous allez devoir refaire l'effort de comprendre votre code à chaque que vous tomberez dessus. Ici ce n'est qu'une ternaire, mais ça peut être plus lourd que ça. On va donc l'extraire lui aussi en rendant le <code>DumbUser</code> paramétrable :</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> withLoading <span class="token punctuation">(</span>DumbUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> props<span class="token punctuation">.</span>loading
      <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StylishSpinner</span> <span class="token punctuation">/></span></span>
      <span class="token punctuation">:</span> <span class="token operator">&lt;</span>DumbUser <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> User <span class="token operator">=</span> <span class="token function">withLoading</span><span class="token punctuation">(</span>DumbUser<span class="token punctuation">)</span>
</code></pre>
<p>NB : Il est important de faire passer les propriétés qui venaient d'en haut au DumbUser, sinon on ne sera pas capable d'afficher quoique ce soit.</p>
<p>Et si on renomme le <code>DumbUser</code>, on se rend compte que nous avons fait un HOC :</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> withLoading <span class="token punctuation">(</span>BaseComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Début du EnhancedComponent</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> props<span class="token punctuation">.</span>loading
      <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StylishSpinner</span> <span class="token punctuation">/></span></span>
      <span class="token punctuation">:</span> <span class="token operator">&lt;</span>BaseComponent <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// Fin du EnhancedComponent</span>
<span class="token punctuation">)</span>
</code></pre>
<p>Cependant, nous pouvons encore l'améliorer. Admettons que vous avez un autre composant ailleurs qui utilise <code>props.isDone</code> plutôt que <code>props.loading</code> pour définir s'il est entrain de charger ou non. Cela veut dire qu'il faut aussi extraire cette partie et la mettre en paramètre :</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> withLoading <span class="token punctuation">(</span>isLoading<span class="token punctuation">,</span> BaseComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">isLoading</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>StylishSpinner</span> <span class="token punctuation">/></span></span>
      <span class="token punctuation">:</span> <span class="token operator">&lt;</span>BaseComponent <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> User <span class="token operator">=</span> <span class="token function">withLoading</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> props<span class="token punctuation">.</span>loading<span class="token punctuation">,</span>
  DumbUser
<span class="token punctuation">)</span>
</code></pre>
<p>Et paf ! On a fait un HOC.</p>
<h4 id="fetcher"><a class="header-anchor" href="#fetcher" aria-hidden="true">#</a> Fetcher</h4>
<p>Maintenant, prenons un exemple un petit peu plus complexe. Le principe reste le même : faire en sorte d'isoler une partie de la fonctionnalité du composant en respectant la formule : <code>(BaseComponent) =&gt; EnhancedComponent</code>.</p>
<pre class="language-jsx"><code><span class="token comment" spellcheck="true">// 1. Définition des paramètres</span>
<span class="token keyword">function</span> fetchData <span class="token punctuation">(</span><span class="token punctuation">{</span>
  getRequest<span class="token punctuation">,</span>
  addResultToProps<span class="token punctuation">,</span>
  BaseComponent
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 2. Renvoie d'un nouveau composant</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
    constructor <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        loading<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    componentWillMount <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 3. Personnalisation grâce aux paramètres</span>
      <span class="token function">getRequest</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          loading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          data<span class="token punctuation">:</span> data
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    render <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 3. Personnalisation grâce aux paramètres</span>
      <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">addResultToProps</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state
      <span class="token punctuation">)</span>

      <span class="token keyword">return</span> <span class="token operator">&lt;</span>BaseComponent <span class="token punctuation">{</span><span class="token operator">...</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ol>
<li>
<p><strong>Définition des paramètres</strong><br>
Le HOC est toujours une fonction. Celle-ci a plus de paramètres mais il y a toujours le BaseComponent en entrée.</p>
</li>
<li>
<p><strong>Renvoie d'un nouveau composant</strong><br>
Le but est de renvoyer un composant amélioré. Tout à l'heure c'était un composant Stateless et donc ce n'était pas forcément très visible. Ici avec le mot clé <code>class</code>, c'est peut-être plus facile de voir la différence entre le <code>HOC</code> et le <code>EnhancedComponent</code>. Et qui dit composant dit qu'il est capable de faire exactement la même chose que ce qu'il aurait dû faire en dehors d'un HOC : constructeur, lifecycle, <strong>render</strong>, etc.</p>
</li>
<li>
<p><strong>Personnalisation grâce aux paramètres</strong><br>
Les paramètres permettent d'extraire la véritable valeur du composant en posant les bonnes questions :</p>
<ul>
<li>Quelle requête faut-il faire à l'API ?</li>
<li>Quelles propriétés venant de l'API faut-il ajouter en propriété à mon <code>BaseComponent</code> ? <em>Cette question sera très souvent posée dans vos HOC car chaque BaseComponent aura besoin de propriétés différentes. De plus, cela permet d'expliciter l'arrivée de nouvelles propriétés.</em></li>
</ul>
<p>Ainsi, quand on lit les paramètres on n'a plus besoin de comprendre le fonctionnement intrinsèque du composant pour savoir ce qu'il fait.</p>
</li>
</ol>
<p>Pour faire un composant qui va chercher dans une API l'utilisateur connecté puis qui l'affiche, cela donne donc :</p>
<pre class="language-jsx"><code><span class="token keyword">var</span> LoggedUser <span class="token operator">=</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  getRequest<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/me'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  addResultToProps<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>props<span class="token punctuation">,</span>
      user<span class="token punctuation">:</span> result<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  BaseComponent<span class="token punctuation">:</span> User
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>NB : Il est possible que vous ayez plus de mal à comprendre le fonctionnement de ce HOC. Si c'est le cas, essayez de le réécrire comme vous l'auriez écrit sans HOC afin de refaire les étapes d'extraction que j'ai explicité sur le <code>withLoading</code>.</p>
<h4 id="composition"><a class="header-anchor" href="#composition" aria-hidden="true">#</a> Composition</h4>
<p>Maintenant qu'on a deux HOC, on peut se dire qu'on va essayer de faire un HOC plus général qui permettra de faire directement le lien entre <code>LoggedUser</code> et <code>DumbUser</code>. En effet, pour l'instant ça ne s'enchaîne pas très bien :</p>
<pre class="language-jsx"><code><span class="token keyword">function</span> DumbUser <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
      <span class="token punctuation">{</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> CurrentUsername <span class="token operator">=</span> <span class="token function">withLoading</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> props<span class="token punctuation">.</span>loading <span class="token punctuation">}</span><span class="token punctuation">,</span>
  DumbUser
<span class="token punctuation">)</span>

<span class="token keyword">var</span> LoggedUser <span class="token operator">=</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  getRequest<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/me'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  addResultToProps<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>props<span class="token punctuation">,</span>
      user<span class="token punctuation">:</span> result<span class="token punctuation">.</span>data
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  BaseComponent<span class="token punctuation">:</span> CurrentUsername
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Si vous avez suivi le <code>pipe</code> de tout à l'heure, ça marchait bien parce qu'à chaque fois, en paramètre, on n'avait qu'un tableau et que le résultat n'était qu'un tableau. On va donc réécrire nos HOC pour les faire fonctionner de la même façon. C'est à dire que l'on va créer des fonctions qui génèrent des HOC qui n'ont que le <code>BaseComponent</code> en paramètre.</p>
<pre class="language-jsx"><code><span class="token comment" spellcheck="true">// Le HOC</span>
  <span class="token keyword">var</span> withLoading <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>isLoading<span class="token punctuation">,</span> BaseComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// Devient</span>
  <span class="token keyword">var</span> withLoading <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>isLoading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>BaseComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Et donc, à l'utilisation</span>
  <span class="token keyword">const</span> CurrentUsername <span class="token operator">=</span> <span class="token function">withLoading</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> props<span class="token punctuation">.</span>loading <span class="token punctuation">}</span><span class="token punctuation">,</span>
    DumbUser
  <span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// Devient</span>
  <span class="token keyword">var</span> withDefaultLoading <span class="token operator">=</span> <span class="token function">withLoading</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> props<span class="token punctuation">.</span>loadin <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">var</span> CurrentUsername <span class="token operator">=</span> <span class="token function">withDefaultLoading</span><span class="token punctuation">(</span>
    DumbUser
  <span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// Ce que vous pouvez simplifier en</span>
  <span class="token keyword">var</span> CurrentUsername <span class="token operator">=</span> <span class="token function">withLoading</span><span class="token punctuation">(</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> props<span class="token punctuation">.</span>loadin <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">(</span>DumbUser<span class="token punctuation">)</span>
</code></pre>
<p>Je peux concevoir que ces transformations ne vous parlent pas plus que ça pour l'instant, mais si vous appliquez les mêmes sur <code>fetchData</code>, vous allez pouvoir réécrire votre <code>LoggedUser</code> ainsi :</p>
<pre class="language-jsx"><code><span class="token keyword">const</span> LoggedUser <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">withLoading</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">(</span>Username<span class="token punctuation">)</span>
</code></pre>
<p>Cela se lit : <code>LoggedUser</code> va mettre à disposition des données venant de l'API via <code>fetchData</code> et l'affichera via un composant qui aura une étape de chargement via <code>withLoading</code> avant d'afficher le <code>DumbUser</code></p>
<p><small><a href="http://ramdajs.com/0.21.0/docs/#compose"><code>compose</code> est tiré de ramda.</a> <a href="https://lodash.com/docs#flowLeft">L'équivalent serait <code>flowRight</code> en lodash.</a> La différence par rapport au <code>pipe</code> ou <code>flow</code> est le sens de composition. Ici c'est le résultat de <code>withLoading</code> qui est passé à <code>fetchData</code> et non l'inverse.</small></p>
<p>Et là, on atteint le stade <em>Chocapic</em> parce qu'on arrive à composer nos HOC et donc à bien enchaîner la lecture des étapes d'améliorations.</p>
<h4 id="mise-en-pratique-au-quotidien"><a class="header-anchor" href="#mise-en-pratique-au-quotidien" aria-hidden="true">#</a> Mise en pratique au quotidien</h4>
<p>Sauf si vous êtes vraiment très fort, si c'est la première fois que vous êtes face à un concept de ce genre, vous vous sentez sûrement un petit peu perdu. C'est normal.</p>
<p>Cependant, j'ai une petite astuce qui a fonctionné pour moi : j'ai arrêté d'utiliser le mot clé <code>class</code> dans mon code React. Pour faire cela, j'ai utilisé la librairie <a href="https://github.com/acdlite/recompose">Recompose</a> qui met à disposition tout un tas de HOC bas niveaux qui vont vous permettre d'abstraire le <code>state</code> (via <a href="https://github.com/acdlite/recompose/blob/c68853e6b451973c1c3ae261d98c78104a6c0701/docs/API.md#withstate">withState</a>), les <code>handlers</code> (via <a href="https://github.com/acdlite/recompose/blob/c68853e6b451973c1c3ae261d98c78104a6c0701/docs/API.md#withhandlers">withHandlers</a>), <a href="https://github.com/acdlite/recompose/blob/c68853e6b451973c1c3ae261d98c78104a6c0701/docs/API.md">et plein d'autres trucs</a>.</p>
<p>Quand vous en aurez fait quelques uns, a priori, vous serez capable de faire de la composition sur n'importe quoi.</p>
<p>Depuis, je n'utilise presque plus <code>recompose</code> parce qu'il n'est pas nécessaire de séparer un <code>state</code> de ses <code>handlers</code>. Par contre, j'utilise toujours autant de HOC avec en plus la joie de comprendre ce que je fais. :)</p>
<h2 id="les-bonnes-pratiques"><a class="header-anchor" href="#les-bonnes-pratiques" aria-hidden="true">#</a> Les bonnes pratiques</h2>
<p>Maintenant que nous connaissons les bases, voici 3 conseils en plus qui vous permettront de tirer le meilleur de ce pattern.</p>
<h3 id="ne-pas-surgeneraliser-les-hoc"><a class="header-anchor" href="#ne-pas-surgeneraliser-les-hoc" aria-hidden="true">#</a> Ne pas surgénéraliser les HOC</h3>
<p>Le risque est de se dire que quelque chose dépend d'un composant et de complexifier le HOC alors que pour l'instant vous n'en avez pas besoin.</p>
<p>Par exemple, l'extraction du paramètre <code>isLoading</code> dans mon <code>withLoading</code> est certainement inutile.</p>
<p>Dans le pire des cas, si un jour vous avez besoin d'un paramètre en plus, vous pouvez tout à fait le rajouter. Il vous suffira de lui donner une valeur par défaut pour que tous ceux qui utilisaient déjà le HOC fonctionnent toujours.</p>
<h3 id="toujours-respecter-la-meme-signature"><a class="header-anchor" href="#toujours-respecter-la-meme-signature" aria-hidden="true">#</a> Toujours respecter la même signature</h3>
<p><code>({paramA, paramB, paramC}) =&gt; (BaseComponent) =&gt; EnhancedComponent</code></p>
<ol>
<li>
<p><strong>Séparer le <code>BaseComponent</code></strong> du reste des paramètres. Cela vous permettra de composer plus facilement vos HOC sans recourir à des astuces à base de <code>.bind</code>.</p>
</li>
<li>
<p><strong>Utiliser un seul paramètre qui est un objet d'options</strong> plutôt qu'une liste de paramètres (cf. <code>fetchData</code>). Cela vous permettra de nommer les paramètres lors de l'utilisation du HOC. Ainsi le besoin auquel répond chaque option sera explicite et vous n'aurez pas à revenir à l'implémentation du HOC pour le comprendre.</p>
</li>
</ol>
<h3 id="decouper-et-nommer-chaque"><a class="header-anchor" href="#decouper-et-nommer-chaque" aria-hidden="true">#</a> Découper et nommer chaque <code>compose</code></h3>
<p>Si vous adoptez <code>recompose</code> il y a de fortes chances que vous vous retrouviez avec des <code>compose</code> unissant beaucoup de HOC. Si c'est le cas, cela veut sûrement dire que vous améliorez votre composant pour trop de raisons à la fois. Séparer explicitement ces raisons en les nommant vous sera utile. Vous validerez ainsi votre schéma de pensée et permettrez aux autres de plus facilement le comprendre.</p>
<p>A propos de la nomenclature de nommage, il n'y a pas vraiment de convention établie mais, généralement, les noms des HOC sont en <code>camelCase</code>.</p>
<h2 id="alors-vous-vous-y-mettez"><a class="header-anchor" href="#alors-vous-vous-y-mettez" aria-hidden="true">#</a> Alors, vous vous y mettez ?</h2>
<p>Personnellement, ce pattern m'a beaucoup apporté.</p>
<p>Mon code est mieux découpé et lisible étant donné que chaque HOC fait une seule chose. Mon code est plus maintenable puisqu'il me suffit de changer le contenu du HOC pour corriger le bug qui les affecte tous. Et surtout, mon code s'est amélioré dans sa globalité et non uniquement en React, parce que j'ai redécouvert une façon de faire qui est utile quelque soit la techno ou l'environnement.</p>
<p>Par contre, il ne faut pas se leurrer : ce n'est pas une solution miracle. D'une part parce qu'elle est difficile à prendre en main si vous ne venez pas du monde fonctionnel. D'autre part parce que ce n'est qu'une astuce pour rendre votre code plus lisible et maintenable. Il faut bien connaître le modèle qui est utilisé en dessous (array, composant React ou autre) pour que le pattern soit réellement efficace.</p>
<p>Mais ça vous le coup d'essayer, non ? :)</p>
</div></div><hr data-reactid="25"/><div data-reactid="26"><footer class="page-footer" data-reactid="27"><!-- react-text: 28 -->Si vous voulez suivre mes publications, il paraît que j&#x27;ai un feed <!-- /react-text --><a href="/feed.xml" data-reactid="29">RSS</a><!-- react-text: 30 --> et un <!-- /react-text --><a href="https://twitter.com/JulienPradet" data-reactid="31">Twitter</a><!-- react-text: 32 -->.<!-- /react-text --><br data-reactid="33"/><!-- react-text: 34 -->Si vous pensez à d&#x27;autres méthodes que vous voudriez que je mette en place (pigeon voyageur, avion en papier, etc.), n&#x27;hésitez pas à me les proposer :)<!-- /react-text --></footer><hr data-reactid="35"/></div><div data-reactid="36"><h2 data-reactid="37">Les derniers articles</h2><ul class="page-list" data-reactid="38"><li class="page-list__item" data-reactid="39"><div class="page-preview" data-reactid="40"><a class="page-preview__title" href="/posts/des-animations-performantes-1" data-reactid="41">Des animations performantes - Partie 1</a><div class="page-preview__meta" data-reactid="42"><time data-reactid="43">Friday, February 17, 2017</time></div><div class="page-preview__description" data-reactid="44"><!-- react-text: 45 -->Faire des animations, c&#x27;est cool. Faire des animations qui ne lag pas, c&#x27;est mieux. Voici la première des trois techniques dont je vais vous parler.<!-- /react-text --><!-- react-text: 46 --> <!-- /react-text --></div><div class="page-preview__read-more" data-reactid="47"><a href="/posts/des-animations-performantes-1" data-reactid="48">Lire la suite →</a></div></div></li><li class="page-list__item" data-reactid="49"><div class="page-preview" data-reactid="50"><a class="page-preview__title" href="/posts/react-router-v4" data-reactid="51">React Router V4</a><div class="page-preview__meta" data-reactid="52"><time data-reactid="53">Friday, February 3, 2017</time></div><div class="page-preview__description" data-reactid="54"><!-- react-text: 55 -->La librairie la moins concurrencée de l&#x27;écosystème React se refond. Cette fois elle embrasse totalement l&#x27;esprit React. Pourquoi c&#x27;est cool ?<!-- /react-text --><!-- react-text: 56 --> <!-- /react-text --></div><div class="page-preview__read-more" data-reactid="57"><a href="/posts/react-router-v4" data-reactid="58">Lire la suite →</a></div></div></li></ul></div><a href="/" data-reactid="59">Revenir à la page d&#x27;accueil</a></div></div><footer class="footer" data-reactid="60"><ul data-reactid="61"><li data-reactid="62"><a href="https://twitter.com/JulienPradet" data-reactid="63"><span class="SVGInline SVGInline--cleaned" data-reactid="64"><svg class="SVGInline-svg SVGInline--cleaned-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 4.557a9.83 9.83 0 0 1-2.828.775 4.932 4.932 0 0 0 2.165-2.724 9.864 9.864 0 0 1-3.127 1.195 4.916 4.916 0 0 0-3.594-1.555c-3.18 0-5.515 2.966-4.797 6.045A13.978 13.978 0 0 1 1.67 3.15a4.93 4.93 0 0 0 1.524 6.573 4.903 4.903 0 0 1-2.23-.616c-.053 2.28 1.582 4.415 3.95 4.89a4.935 4.935 0 0 1-2.224.084 4.928 4.928 0 0 0 4.6 3.42A9.9 9.9 0 0 1 0 19.54a13.94 13.94 0 0 0 7.548 2.212c9.142 0 14.307-7.72 13.995-14.646A10.025 10.025 0 0 0 24 4.556z"/></svg></span><span class="name" data-reactid="65">@JulienPradet</span></a></li><li data-reactid="66"><a href="https://github.com/JulienPradet/blog-posts" data-reactid="67"><span class="SVGInline SVGInline--cleaned" data-reactid="68"><svg class="SVGInline-svg SVGInline--cleaned-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.6.11.793-.26.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.09-.745.083-.73.083-.73 1.205.085 1.84 1.238 1.84 1.238 1.07 1.834 2.806 1.304 3.49.997.108-.776.42-1.306.763-1.605-2.665-.305-5.467-1.334-5.467-5.93 0-1.312.47-2.382 1.236-3.222-.125-.303-.536-1.524.116-3.176 0 0 1.008-.322 3.3 1.23A11.51 11.51 0 0 1 12 5.803c1.02.005 2.047.138 3.006.404 2.29-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.236 1.91 1.236 3.22 0 4.61-2.807 5.625-5.48 5.922.43.372.824 1.102.824 2.222v3.293c0 .32.192.694.8.576C20.567 21.796 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg></span><span class="name" data-reactid="69">JulienPradet</span></a></li></ul></footer></div><!-- react-empty: 70 --><!-- react-empty: 71 --></div></div><script data-reactid="5">__REACT_ASYNC_COMPONENTS_STATE__ = {"resolved":{"1":true}}</script><script defer="" src="../../app.7bed6fc368b67c6b70dd.js" data-reactid="6"></script></body></html>